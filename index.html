<!doctype html>
<html>
<head>
  <script src="node_modules/fetch-sync/dist/fetch-sync.js"></script>
  <style>
    #error { display: none; color: red; }
    #main { display: none; }
    #waiting-result { display: none; }
  </style>
</head>
<body>
<div id="error"></div>
<p id="waiting-worker">Waiting for service worker... (refresh the page?)</p>
<div id="main">
  <ol>
    <li>Go offline
    <li>Click the button below
    <li>Go online
    <li>Be patient...
    <li>Random cat gif, yay!
  </ol>
  <button id="make-request" onclick="makeRequest()">Make request</button>
  <p id="waiting-result">
    Waiting...<br>
    It may take some time (potentially minutes)...<br>
    Come back in a little while...
    <br><br>
    (Unfortunately this can't be helped. It is up to the browser to decide when the UA is most likely to be able to
    fulfill the request again after regaining connectivity.)
  </p>
  <img id="result" />
</div>
<script>
  /* global fetchSync:false */

  var GET_ME_A_CAT = 'https://thecatapi.com/api/images/get?format=src&type=gif'

  var main = document.querySelector('#main')
  var error = document.querySelector('#error')
  var waitingWorker = document.querySelector('#waiting-worker')
  var waitingResult = document.querySelector('#waiting-result')
  var makeRequestBtn = document.querySelector('#make-request')
  var result = document.querySelector('#result')

  var request = null

  navigator.serviceWorker
    .register('./sw.js', { scope: './' })
    .then(function () {
      return fetchSync.init()
    })
    .then(function () {
      waitingWorker.style.display = 'none'
      main.style.display = 'block'
    })
    .catch(function (err) {
      main.style.display = 'none'
      error.style.display = 'block'
      error.innerText = err.message
      throw err
    })

  function makeRequest () {
    if (request) {
      return
    }

    waitingResult.style.display = 'block'

    request = fetchSync(GET_ME_A_CAT)
      .then(function (response) {
        return response.blob()
      })
      .then(function (blob) {
        result.src = URL.createObjectURL(blob)
        request = false
        waitingResult.style.display = 'none'
        makeRequestBtn.style.display = 'none'
      })
      .catch(function (err) {
        main.style.display = 'none'
        error.style.display = 'block'
        error.innerText = err.message
        throw err
      })
  }
</script>
</body>
</html>
